// path: src/App.tsx
// Fiche véhicule IG — V5
// Changements majeurs (demandes client):
// - Contrôles du flou SOUS la prévisualisation (iPhone friendly)
// - Bouton "Télécharger PNG" à côté de l'aperçu
// - Téléphone plus haut + fond AD bleu (pas rose)
// - Nom du garage près du logo, non affecté par le flou (panneau blanc)
// - Statut (RÉSERVÉ/VENDU) : taille réduite + style timbre (contour blanc)
// - Suppression du ruban bas

import React, { useEffect, useRef, useState } from "react";

// ========================= Types & Const =========================

type Preset = "square" | "portrait" | "story";

interface VehicleData {
  make: string; model: string; version: string; features: string;
  year: string; gearbox: string; fuel: string; mileage: string; power: string;
  price: string; phone: string;
}

interface ThemeDef { primary: string; blue: string; fg: string; sub: string; bg: string; }

const THEME: ThemeDef = {
  primary: "#E30613",   // AD rouge (accent: prix, statut)
  blue:    "#001E62",   // AD bleu (pill téléphone)
  fg:      "#111827",
  sub:     "#4B5563",
  bg:      "#FFFFFF",
};

const PRESETS: Record<Preset, { w: number; h: number; label: string }> = {
  square:   { w: 1080, h: 1080, label: "Carré 1080×1080" },
  portrait: { w: 1080, h: 1350, label: "Portrait 1080×1350" },
  story:    { w: 1080, h: 1920, label: "Story 1080×1920" },
};

const DEFAULT_VEHICLE: VehicleData = {
  make: "DACIA", model: "SANDERO", version: "1.5 DCI",
  features: "CAMÉRA – GPS – TOIT PANO – CROCHET ATTELAGE",
  year: "2019", gearbox: "MANUELLE", fuel: "ESSENCE", mileage: "110000", power: "110",
  price: "12000", phone: "05 55 22 00 22",
};

const fr = new Intl.NumberFormat("fr-FR");

// ========================= Utils =========================

function formatPriceEUR(input: string): string {
  const digits = (input || "").replace(/[^0-9]/g, "");
  return digits ? fr.format(Number(digits)) + " €" : "";
}
function formatKm(input: string): string {
  const digits = (input || "").replace(/[^0-9]/g, "");
  return digits ? fr.format(Number(digits)) + " KMS" : "";
}
function fitCover(srcW: number, srcH: number, dstW: number, dstH: number) {
  const srcRatio = srcW / srcH; const dstRatio = dstW / dstH;
  if (srcRatio > dstRatio) { const sH = srcH; const sW = sH * dstRatio; const sx = (srcW - sW) / 2; return { sx, sy: 0, sW, sH }; }
  const sW = srcW; const sH = sW / dstRatio; const sy = (srcH - sH) / 2; return { sx: 0, sy, sW, sH };
}
async function loadImage(url: string): Promise<HTMLImageElement> {
  return new Promise((resolve, reject) => { const img = new Image(); img.onload = () => resolve(img); img.onerror = reject; img.src = url; });
}
function rr(ctx: CanvasRenderingContext2D, x: number, y: number, w: number, h: number, r: number) {
  const t = Math.min(r, w/2, h/2); ctx.beginPath(); ctx.moveTo(x+t,y); ctx.arcTo(x+w,y,x+w,y+h,t); ctx.arcTo(x+w,y+h,x,y+h,t); ctx.arcTo(x,y+h,x,y,t); ctx.arcTo(x,y,x+w,y,t); ctx.closePath();
}
function starburst(ctx: CanvasRenderingContext2D, cx: number, cy: number, outer: number, inner: number, points = 14) {
  ctx.beginPath(); const step = Math.PI / points; for (let i=0;i<2*points;i++){ const r = (i%2===0)? outer : inner; const a = i*step; const x = cx + Math.cos(a)*r; const y = cy + Math.sin(a)*r; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.closePath();
}
function drawStatus(ctx: CanvasRenderingContext2D, text: string, rect: {x:number;y:number;w:number;h:number}, color: string) {
  // Style "timbre": plus petit + contour blanc
  ctx.save(); ctx.translate(rect.x + rect.w/2, rect.y + rect.h/2); ctx.rotate(-Math.PI/14);
  ctx.textAlign = "center"; ctx.textBaseline = "middle";
  ctx.font = "900 112px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.lineWidth = 10; ctx.strokeStyle = "#FFFFFF"; ctx.miterLimit = 2; ctx.lineJoin = "round";
  ctx.strokeText(text, 0, 0);
  ctx.fillStyle = color; ctx.fillText(text, 0, 0);
  ctx.restore();
}

// ========================= App =========================

export default function App() {
  const [preset, setPreset] = useState<Preset>("portrait");
  const dims = PRESETS[preset];

  const [vehicle, setVehicle] = useState<VehicleData>(DEFAULT_VEHICLE);
  const [dealerName, setDealerName] = useState("GARAGE LAUMOND – Lanteuil • Meyssac • Argentat");

  const [logoUrl, setLogoUrl] = useState<string | null>(null);
  const [photoUrl, setPhotoUrl] = useState<string | null>(null);

  // Focus ellipse
  const [focus, setFocus] = useState({ scaleX: 0.82, scaleY: 0.60, offsetY: 0.00 });
  const [status, setStatus] = useState<"aucun" | "RÉSERVÉ" | "VENDU">("aucun");

  const previewRef = useRef<HTMLCanvasElement | null>(null);
  const exportRef  = useRef<HTMLCanvasElement | null>(null);

  useEffect(()=>{ (async()=>{ const c=previewRef.current; if(!c) return; const ratio=0.38; c.width=Math.round(dims.w*ratio); c.height=Math.round(dims.h*ratio); const off=document.createElement('canvas'); off.width=dims.w; off.height=dims.h; await render(off); const ctx=c.getContext('2d'); ctx?.drawImage(off,0,0,c.width,c.height); })(); },[preset, vehicle, dealerName, logoUrl, photoUrl, focus, status, dims.w, dims.h]);

  async function render(target: HTMLCanvasElement){ await renderSheet(target, { preset, vehicle, dealerName, logoUrl, photoUrl, focus, status }); }

  function onPick(setter: (u: string | null)=>void){ return (file?: File)=>{ if(!file || !file.type.startsWith('image/')) return; const url=URL.createObjectURL(file); setter(prev=>{ if(prev) URL.revokeObjectURL(prev); return url; }); }; }

  async function downloadPNG(){ const c=exportRef.current; if(!c) return; c.width=dims.w; c.height=dims.h; await render(c); c.toBlob(b=>{ if(!b) return; const url=URL.createObjectURL(b); const a=document.createElement('a'); const fn=`${vehicle.make}-${vehicle.model}-${vehicle.year}-${preset}`.replace(/[^a-z0-9-_]+/gi,'-'); a.href=url; a.download=fn+`.png`; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1200); },'image/png'); }

  return (
    <div className="min-h-screen p-4 sm:p-6" style={{ background: THEME.bg, color: THEME.fg }}>
      <div className="max-w-7xl mx-auto grid grid-cols-1 xl:grid-cols-[420px_1fr] gap-6">
        {/* ===================== Formulaire gauche ===================== */}
        <div className="space-y-5">
          <h1 className="text-2xl font-bold">Fiche véhicule Instagram</h1>

          <Section title="Photo véhicule">
            <div className="flex flex-wrap gap-2">
              <FileButton label="Prendre une photo (iPhone)" accept="image/*" capture onPick={onPick(setPhotoUrl)} />
              <FileButton label="Importer une photo" accept="image/*" onPick={onPick(setPhotoUrl)} />
            </div>
          </Section>

          <Section title="Logo & identité">
            <div className="flex items-center gap-3">
              <FileButton label="Logo AD (PNG/SVG)" accept="image/*,.svg" onPick={onPick(setLogoUrl)} />
              <small className="text-gray-500">Sans logo ⇒ carré rouge « AD »</small>
            </div>
            <Input label="Nom garage" value={dealerName} onChange={setDealerName} />
          </Section>

          <Section title="Détails véhicule">
            <div className="grid grid-cols-2 gap-3">
              <Input label="Marque" value={vehicle.make} onChange={v=>setVehicle({...vehicle, make:v})} />
              <Input label="Modèle" value={vehicle.model} onChange={v=>setVehicle({...vehicle, model:v})} />
              <Input label="Version / Finition" value={vehicle.version} onChange={v=>setVehicle({...vehicle, version:v})} />
              <Input label="Caractéristiques (– séparés)" value={vehicle.features} onChange={v=>setVehicle({...vehicle, features:v})} />
              <Input label="Année" value={vehicle.year} onChange={v=>setVehicle({...vehicle, year:v})} />
              <Input label="Boîte" value={vehicle.gearbox} onChange={v=>setVehicle({...vehicle, gearbox:v})} />
              <Input label="Énergie" value={vehicle.fuel} onChange={v=>setVehicle({...vehicle, fuel:v})} />
              <Input label="Puissance (ch)" value={vehicle.power} onChange={v=>setVehicle({...vehicle, power:v})} />
              <Input label="Kilométrage" value={vehicle.mileage} onChange={v=>setVehicle({...vehicle, mileage:v})} />
              <Input label="Téléphone" value={vehicle.phone} onChange={v=>setVehicle({...vehicle, phone:v})} />
              <Select label="Statut" value={status} onChange={v=>setStatus(v as any)} options={["aucun","RÉSERVÉ","VENDU"]} />
              <Select label="Format" value={preset} onChange={v=>setPreset(v as Preset)} options={["square","portrait","story"]} />
            </div>
          </Section>
        </div>

        {/* ===================== Prévisualisation droite ===================== */}
        <div className="space-y-3">
          <div className="flex items-center justify-between">
            <div className="text-sm text-gray-500">Prévisualisation ({PRESETS[preset].label})</div>
            <div className="flex gap-2">
              <button className="px-3 py-2 rounded-xl border" onClick={downloadPNG}>Télécharger PNG</button>
            </div>
          </div>

          <div className="relative">
            <canvas ref={previewRef} className="w-full max-w-[720px] border rounded-xl" />
          </div>

          {/* Contrôles rapides sous l'aperçu (iPhone friendly) */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-3 bg-white p-3 rounded-xl border">
            <Slider label="Focus largeur" value={focus.scaleX} setValue={v=>setFocus({...focus, scaleX:v})} min={0.5} max={1.1} step={0.01} />
            <Slider label="Focus hauteur" value={focus.scaleY} setValue={v=>setFocus({...focus, scaleY:v})} min={0.45} max={1.1} step={0.01} />
            <Slider label="Position verticale" value={focus.offsetY} setValue={v=>setFocus({...focus, offsetY:v})} min={-0.25} max={0.25} step={0.005} />
          </div>

          {/* Canvas export caché */}
          <canvas ref={exportRef} className="hidden" />
        </div>
      </div>
    </div>
  );
}

// ========================= Rendu Canvas (layout verrouillé) =========================

interface RenderInput {
  preset: Preset; vehicle: VehicleData; dealerName: string; logoUrl: string | null; photoUrl: string | null;
  focus: { scaleX:number; scaleY:number; offsetY:number }; status: "aucun"|"RÉSERVÉ"|"VENDU";
}

async function renderSheet(canvas: HTMLCanvasElement, data: RenderInput){
  const { preset, vehicle, dealerName, logoUrl, photoUrl, focus, status } = data;
  const { w: outW, h: outH } = PRESETS[preset];
  const ctx = canvas.getContext('2d'); if(!ctx) return;

  // Fond
  ctx.clearRect(0,0,outW,outH); ctx.fillStyle = THEME.bg; ctx.fillRect(0,0,outW,outH);

  // Bordure extérieure fine (bleu)
  const B=8; ctx.strokeStyle = THEME.blue; ctx.lineWidth = B; ctx.strokeRect(B/2+16, B/2+16, outW-B-32, outH-B-32);

  // Zone photo
  const M=56; const photoH=Math.round(outH*0.58); const photoRect={ x:M, y:M, w: outW-2*M, h: photoH };
  ctx.save(); rr(ctx,photoRect.x,photoRect.y,photoRect.w,photoRect.h,44); ctx.clip();
  if(photoUrl){
    const img = await loadImage(photoUrl); const {sx,sy,sW,sH}=fitCover(img.naturalWidth,img.naturalHeight,photoRect.w,photoRect.h);
    // Fond flouté
    const any: any = ctx; const prev = any.filter; any.filter = 'blur(24px)';
    ctx.drawImage(img, sx,sy,sW,sH, photoRect.x,photoRect.y,photoRect.w,photoRect.h); any.filter = prev;
    // Ellipse nette
    const cx=photoRect.x+photoRect.w/2; const cy=photoRect.y+photoRect.h*(0.5+focus.offsetY);
    const rx=(photoRect.w/2)*focus.scaleX; const ry=(photoRect.h/2)*focus.scaleY; ctx.save(); ctx.beginPath(); ctx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2); ctx.clip();
    ctx.drawImage(img, sx,sy,sW,sH, photoRect.x,photoRect.y,photoRect.w,photoRect.h); ctx.restore();
    // Dégradé en haut (lisibilité titres éventuels sur photo)
    const g=ctx.createLinearGradient(0,photoRect.y,0,photoRect.y+160); g.addColorStop(0,'rgba(0,0,0,0.28)'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.fillRect(photoRect.x,photoRect.y,photoRect.w,Math.min(160,photoRect.h));
  } else {
    const g=ctx.createLinearGradient(0,photoRect.y,0,photoRect.y+photoRect.h); g.addColorStop(0,'#E5E7EB'); g.addColorStop(1,'#F3F4F6'); ctx.fillStyle=g; ctx.fillRect(photoRect.x,photoRect.y,photoRect.w,photoRect.h);
  }
  ctx.restore();

  // Panneau logo + nom garage (AU-DESSUS du flou)
  const pad=26; const panelH=74; const panelX=photoRect.x+pad; const panelY=photoRect.y+pad; const panelW=Math.min(620, photoRect.w-2*pad);
  ctx.save(); rr(ctx,panelX-14,panelY-10,panelW+28,panelH+20,16); ctx.fillStyle='rgba(255,255,255,0.92)'; ctx.fill();
  // Logo
  if(logoUrl){ try{ const logo=await loadImage(logoUrl); const maxH=48; const f=maxH/logo.naturalHeight; const lw=Math.min(140, Math.round(logo.naturalWidth*f)); const lh=Math.round(logo.naturalHeight*f); ctx.drawImage(logo, panelX, panelY, lw, lh); drawDealer(ctx, panelX+lw+14, panelY+lh/2+2, dealerName); }catch{} }
  else { const s=56; rr(ctx,panelX,panelY,s,s,10); ctx.fillStyle=THEME.primary; ctx.fill(); ctx.fillStyle='#fff'; ctx.font='800 34px system-ui,-apple-system,Segoe UI,Roboto'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('AD', panelX+s/2, panelY+s/2+1); drawDealer(ctx, panelX+s+14, panelY+s/2+2, dealerName); }
  ctx.restore();

  // Prix (étoile rouge) — en bas droite de la photo
  const scx = photoRect.x + photoRect.w - 140; const scy = photoRect.y + photoRect.h - 60; ctx.save(); starburst(ctx, scx, scy, 110, 58, 14); ctx.fillStyle=THEME.primary; ctx.fill(); ctx.fillStyle='#fff'; ctx.font='900 40px system-ui,-apple-system,Segoe UI,Roboto'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(formatPriceEUR(vehicle.price), scx, scy+2); ctx.restore();

  // Statut (si présent)
  if(status!=="aucun") drawStatus(ctx, status, photoRect, THEME.primary);

  // Titre + sous-titres
  const titleY=photoRect.y+photoRect.h+34; ctx.fillStyle=THEME.fg; ctx.font='900 66px system-ui,-apple-system,Segoe UI,Roboto'; ctx.fillText(`${(vehicle.make+" "+vehicle.model).toUpperCase()}`.trim(), M, titleY);
  const verY=titleY+44; ctx.font='700 34px system-ui,-apple-system,Segoe UI,Roboto'; ctx.fillText((vehicle.version||'').toUpperCase(), M, verY);
  const featY=verY+44; ctx.font='800 30px system-ui,-apple-system,Segoe UI,Roboto'; wrap(ctx, (vehicle.features||'').toUpperCase(), M, featY, outW-2*M, 36, 2);

  // Specs
  const specsY=featY+60; ctx.fillStyle=THEME.sub; ctx.font='700 30px system-ui,-apple-system,Segoe UI,Roboto'; const specs=[vehicle.year, vehicle.gearbox, vehicle.fuel, `${vehicle.power} ch`, formatKm(vehicle.mileage)].filter(Boolean).join('  •  '); ctx.fillText(specs, M, specsY);
  ctx.strokeStyle="#E5E7EB"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(M, specsY+24); ctx.lineTo(outW-M, specsY+24); ctx.stroke();

  // Téléphone (pilule bleu AD) — PLUS HAUT
  const phoneY = outH - 160; const phoneTxt = vehicle.phone || ""; ctx.font='900 34px system-ui,-apple-system,Segoe UI,Roboto'; const tw = ctx.measureText(phoneTxt).width; const pw = tw + 90; const ph = 58; const px = outW - M - pw; const py = phoneY - ph/2; rr(ctx,px,py,pw,ph,28); ctx.fillStyle=THEME.blue; ctx.fill(); ctx.fillStyle='#fff'; ctx.fillText(phoneTxt, px+56, phoneY+12-12);
  // petit pictogramme tél
  ctx.beginPath(); ctx.arc(px+30, py+ph/2, 10, 0, Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();
}

function drawDealer(ctx: CanvasRenderingContext2D, x: number, midY: number, dealer: string){ ctx.fillStyle=THEME.fg; ctx.font='800 22px system-ui,-apple-system,Segoe UI,Roboto'; const y=midY; ctx.textBaseline='middle'; ctx.fillText(dealer||'', x, y); }

function wrap(ctx: CanvasRenderingContext2D, text: string, x: number, y: number, maxWidth: number, lineHeight: number, maxLines: number){ const words=(text||'').split(/\s+/); let line=''; let lines=0; for(let i=0;i<words.length;i++){ const test=line?line+' '+words[i]:words[i]; const w=ctx.measureText(test).width; if(w>maxWidth && i>0){ ctx.fillText(line,x,y); y+=lineHeight; lines++; line=words[i]; if(lines>=maxLines-1) break; } else line=test; } ctx.fillText(line,x,y); }

// ========================= UI =========================

function Section({ title, children }: { title: string; children: React.ReactNode }){ return (<section className="border rounded-2xl p-4 bg-white"><div className="font-semibold mb-3">{title}</div>{children}</section>); }
function Input({ label, value, onChange }: { label: string; value: string; onChange: (v: string)=>void }){ return (<label className="text-sm"><div className="mb-1 text-gray-600">{label}</div><input className="w-full border rounded-xl px-3 py-2" value={value} onChange={e=>onChange(e.target.value)} /></label>); }
function Select({ label, value, onChange, options }: { label: string; value: string; onChange: (v: string)=>void; options: string[] }){ return (<label className="text-sm"><div className="mb-1 text-gray-600">{label}</div><select className="w-full border rounded-xl px-3 py-2 bg-white" value={value} onChange={e=>onChange(e.target.value)}>{options.map(o=> <option key={o} value={o}>{o}</option>)}</select></label>); }
function Slider({ label, value, setValue, min, max, step }: { label: string; value: number; setValue: (n:number)=>void; min:number; max:number; step:number }){ return (<label className="text-sm"><div className="mb-1 text-gray-600">{label}</div><input type="range" min={min} max={max} step={step} value={value} onChange={e=>setValue(parseFloat(e.target.value))} className="w-full"/></label>); }
function FileButton({ label, accept, onPick, capture }: { label: string; accept: string; onPick: (f?: File)=>void; capture?: boolean }){ return (<label className="px-3 py-2 rounded-2xl border cursor-pointer bg-white">{label}<input type="file" accept={accept} className="hidden" {...(capture?({capture:'environment'} as any):{})} onChange={e=>onPick(e.target.files?.[0])} /></label>); }
