// path: src/App.tsx
// G√©n√©rateur de fiche v√©hicule Instagram avec flou arri√®re‚Äëplan, statut (R√©serv√©/Vendu),
// logo, couleurs personnalisables, et export PNG. iPhone: input capture="environment".
// Documentation inline minimale (pour le "pourquoi").

import React, { useEffect, useMemo, useRef, useState } from "react";

// ========================= Types & Const =========================

type Preset = "square" | "portrait" | "story";

interface VehicleData {
  make: string;
  model: string;
  version: string; // sous-titre
  features: string; // ex: CarPlay/Radars/...
  year: string;
  gearbox: string;
  fuel: string;
  mileage: string; // km
  power: string; // ch
  price: string; // input brut
  city: string;
  phone: string;
}

interface Theme {
  primary: string; // couleur accent (badge prix, statut)
  textDark: boolean; // fond clair vs sombre
  ribbonBg: string;
}

const PRESETS: Record<Preset, { w: number; h: number; label: string }> = {
  square:   { w: 1080, h: 1080, label: "Carr√© 1080√ó1080" },
  portrait: { w: 1080, h: 1350, label: "Portrait 1080√ó1350" },
  story:    { w: 1080, h: 1920, label: "Story 1080√ó1920" },
};

const DEFAULT_VEHICLE: VehicleData = {
  make: "OPEL",
  model: "ADAM",
  version: "1.4 TWINPORT 85ch White Edition",
  features: "CarPlay/Radars/Entretien/Garantie",
  year: "2019",
  gearbox: "Manuelle",
  fuel: "ESSENCE",
  mileage: "71858",
  power: "85",
  price: "9990",
  city: "Brive-la-Gaillarde",
  phone: "06 16 13 15 89",
};

const DEFAULT_THEME: Theme = {
  primary: "#FACC15", // jaune
  textDark: true,
  ribbonBg: "#FACC15",
};

const fr = new Intl.NumberFormat("fr-FR");

// ========================= Utils =========================

function formatPriceEUR(input: string): string {
  const digits = (input || "").replace(/[^0-9]/g, "");
  if (!digits) return "";
  return fr.format(Number(digits)) + "‚Ç¨";
}

function formatKm(input: string): string {
  const digits = (input || "").replace(/[^0-9]/g, "");
  if (!digits) return "";
  return fr.format(Number(digits)) + " km";
}

function isiOS(): boolean {
  return /iPad|iPhone|iPod/.test(navigator.userAgent);
}

function fitCover(srcW: number, srcH: number, dstW: number, dstH: number) {
  const srcRatio = srcW / srcH;
  const dstRatio = dstW / dstH;
  if (srcRatio > dstRatio) {
    const sH = srcH;
    const sW = sH * dstRatio;
    const sx = (srcW - sW) / 2;
    return { sx, sy: 0, sW, sH };
  } else {
    const sW = srcW;
    const sH = sW / dstRatio;
    const sy = (srcH - sH) / 2;
    return { sx: 0, sy, sW, sH };
  }
}

async function loadBitmap(url: string): Promise<{ bmp: ImageBitmap; w: number; h: number } | null> {
  try {
    const res = await fetch(url);
    const blob = await res.blob();
    const bmp = await createImageBitmap(blob);
    return { bmp, w: bmp.width, h: bmp.height };
  } catch {
    return null;
  }
}

function drawRoundRect(ctx: CanvasRenderingContext2D, x: number, y: number, w: number, h: number, r: number) {
  const rr = Math.min(r, w / 2, h / 2);
  ctx.beginPath();
  ctx.moveTo(x + rr, y);
  ctx.arcTo(x + w, y, x + w, y + h, rr);
  ctx.arcTo(x + w, y + h, x, y + h, rr);
  ctx.arcTo(x, y + h, x, y, rr);
  ctx.arcTo(x, y, x + w, y, rr);
  ctx.closePath();
}

/** Irregular "paint blob" for price badge. */
function drawPaintBlob(ctx: CanvasRenderingContext2D, x: number, y: number, w: number, h: number, seed = 0) {
  const r = Math.min(w, h) / 2;
  const cx = x + w / 2;
  const cy = y + h / 2;
  ctx.beginPath();
  for (let i = 0; i < 12; i++) {
    const ang = (i / 12) * Math.PI * 2;
    const rr = r * (0.85 + 0.25 * Math.sin(i * 1.7 + seed));
    const px = cx + Math.cos(ang) * rr;
    const py = cy + Math.sin(ang) * rr;
    if (i === 0) ctx.moveTo(px, py);
    else ctx.quadraticCurveTo(cx, cy, px, py);
  }
  ctx.closePath();
}

/** Big diagonal status text over the photo. */
function drawStatus(ctx: CanvasRenderingContext2D, text: string, rect: { x: number; y: number; w: number; h: number }, color: string) {
  ctx.save();
  ctx.translate(rect.x + rect.w / 2, rect.y + rect.h / 2);
  ctx.rotate(-Math.PI / 14);
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.font = "800 160px Inter, ui-sans-serif, system-ui";
  ctx.shadowColor = "rgba(0,0,0,0.35)";
  ctx.shadowBlur = 18;
  ctx.shadowOffsetY = 6;
  ctx.fillStyle = color;
  ctx.fillText(text, 0, 0);
  ctx.restore();
}

// ========================= App =========================

export default function App() {
  const [preset, setPreset] = useState<Preset>("portrait");
  const dims = PRESETS[preset];

  const [vehicle, setVehicle] = useState<VehicleData>(DEFAULT_VEHICLE);
  const [dealerName, setDealerName] = useState("GARAGE LAUMOND ‚Äì Lanteuil ‚Ä¢ Meyssac ‚Ä¢ Argentat");
  const [ribbonText, setRibbonText] = useState("Garantie 6 mois  ‚Ä¢  En stock  ‚Ä¢  Livraison  ‚Ä¢  Financement  ‚Ä¢  Reprise");

  const [theme, setTheme] = useState<Theme>(DEFAULT_THEME);
  const [logoUrl, setLogoUrl] = useState<string | null>(null);
  const [photoUrl, setPhotoUrl] = useState<string | null>(null);

  // Flou: ovale nette au centre (r√©glable)
  const [focus, setFocus] = useState({ scaleX: 0.78, scaleY: 0.55, offsetY: 0.02 });

  const [status, setStatus] = useState<"aucun" | "R√âSERV√â" | "VENDU">("aucun");

  const previewRef = useRef<HTMLCanvasElement | null>(null);
  const exportRef = useRef<HTMLCanvasElement | null>(null);

  const fontsReady = useFontsReady();

  // Preview re-render
  useEffect(() => {
    (async () => {
      if (!fontsReady) return;
      const c = previewRef.current;
      if (!c) return;
      const ratio = 0.38;
      c.width = Math.round(dims.w * ratio);
      c.height = Math.round(dims.h * ratio);
      const ctx = c.getContext("2d");
      if (!ctx) return;
      const off = document.createElement("canvas");
      off.width = dims.w;
      off.height = dims.h;
      await renderSheet(off, {
        preset,
        vehicle,
        dealerName,
        ribbonText,
        theme,
        logoUrl,
        photoUrl,
        focus,
        status,
      });
      ctx.drawImage(off, 0, 0, c.width, c.height);
    })();
  }, [preset, vehicle, dealerName, ribbonText, theme, logoUrl, photoUrl, focus, status, fontsReady, dims.w, dims.h]);

  async function generateAndDownload() {
    const c = exportRef.current;
    if (!c) return;
    c.width = dims.w;
    c.height = dims.h;
    await renderSheet(c, { preset, vehicle, dealerName, ribbonText, theme, logoUrl, photoUrl, focus, status });
    c.toBlob((blob) => {
      if (!blob) return;
      const url = URL.createObjectURL(blob);
      if (isiOS()) {
        window.open(url, "_blank"); // iOS: open new tab; download attr souvent ignor√©
      } else {
        const a = document.createElement("a");
        const file = `${vehicle.make}-${vehicle.model}-${vehicle.year}-${preset}`.replace(/[^a-z0-9-_]+/gi, "-");
        a.href = url;
        a.download = `${file}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }
      setTimeout(() => URL.revokeObjectURL(url), 1500);
    }, "image/png");
  }

  function handlePick(setter: (v: string | null) => void) {
    return (file?: File) => {
      if (!file || !file.type.startsWith("image/")) return;
      const url = URL.createObjectURL(file);
      setter((prev) => { if (prev) URL.revokeObjectURL(prev); return url; });
    };
  }

  const priceDisplay = formatPriceEUR(vehicle.price);

  return (
    <div className="min-h-screen p-6 bg-white text-gray-900">
      <div className="max-w-7xl mx-auto grid grid-cols-1 xl:grid-cols-[440px_1fr] gap-6">
        {/* === Panneau gauche (formulaire) === */}
        <div className="space-y-5">
          <h1 className="text-2xl font-bold">Fiche v√©hicule Instagram</h1>

          <Fieldset title="Photo v√©hicule">
            <div className="flex flex-wrap gap-2">
              <FileButton label="Prendre une photo (iPhone)" accept="image/*" capture onPick={handlePick(setPhotoUrl)} />
              <FileButton label="Importer une photo" accept="image/*" onPick={handlePick(setPhotoUrl)} />
            </div>
            <div className="grid grid-cols-3 gap-3 mt-3">
              <Slider label="Focus largeur" value={focus.scaleX} setValue={(v) => setFocus({ ...focus, scaleX: v })} min={0.4} max={1.1} step={0.01} />
              <Slider label="Focus hauteur" value={focus.scaleY} setValue={(v) => setFocus({ ...focus, scaleY: v })} min={0.35} max={1.1} step={0.01} />
              <Slider label="Focus position Y" value={focus.offsetY} setValue={(v) => setFocus({ ...focus, offsetY: v })} min={-0.25} max={0.25} step={0.005} />
            </div>
          </Fieldset>

          <Fieldset title="Logo & identit√©">
            <div className="flex items-center gap-3">
              <FileButton label="Logo AD (PNG/SVG)" accept="image/*,.svg" onPick={handlePick(setLogoUrl)} />
              <small className="text-gray-500">Sans logo ‚áí monogramme "AD" auto</small>
            </div>
            <Input label="Nom garage" value={dealerName} onChange={setDealerName} />
            <Input label="Texte ruban bas" value={ribbonText} onChange={setRibbonText} />
            <div className="grid grid-cols-3 gap-3">
              <ColorInput label="Couleur accent" value={theme.primary} onChange={(v) => setTheme({ ...theme, primary: v })} />
              <Select label="Fond" value={theme.textDark ? "clair" : "sombre"} onChange={(v) => setTheme({ ...theme, textDark: v === "clair" })} options={["clair","sombre"]} />
              <ColorInput label="Couleur ruban" value={theme.ribbonBg} onChange={(v) => setTheme({ ...theme, ribbonBg: v })} />
            </div>
          </Fieldset>

          <Fieldset title="D√©tails v√©hicule">
            <div className="grid grid-cols-2 gap-3">
              <Input label="Marque" value={vehicle.make} onChange={(v) => setVehicle({ ...vehicle, make: v })} />
              <Input label="Mod√®le" value={vehicle.model} onChange={(v) => setVehicle({ ...vehicle, model: v })} />
              <Input label="Version / Finition" value={vehicle.version} onChange={(v) => setVehicle({ ...vehicle, version: v })} />
              <Input label="Caract√©ristiques (\/ s√©par√©s)" value={vehicle.features} onChange={(v) => setVehicle({ ...vehicle, features: v })} />
              <Input label="Ann√©e" value={vehicle.year} onChange={(v) => setVehicle({ ...vehicle, year: v })} />
              <Input label="Bo√Æte" value={vehicle.gearbox} onChange={(v) => setVehicle({ ...vehicle, gearbox: v })} />
              <Input label="√ânergie" value={vehicle.fuel} onChange={(v) => setVehicle({ ...vehicle, fuel: v })} />
              <Input label="Puissance (ch)" value={vehicle.power} onChange={(v) => setVehicle({ ...vehicle, power: v })} />
              <Input label="Kilom√©trage" value={vehicle.mileage} onChange={(v) => setVehicle({ ...vehicle, mileage: v })} />
              <Input label="T√©l√©phone" value={vehicle.phone} onChange={(v) => setVehicle({ ...vehicle, phone: v })} />
              <Input label="Ville" value={vehicle.city} onChange={(v) => setVehicle({ ...vehicle, city: v })} />
              <Input label="Prix (‚Ç¨)" value={vehicle.price} onChange={(v) => setVehicle({ ...vehicle, price: v })} />
            </div>
            <div className="grid grid-cols-3 gap-3 mt-3">
              <Select label="Statut" value={status} onChange={(v) => setStatus(v as any)} options={["aucun", "R√âSERV√â", "VENDU"]} />
              <Select label="Format" value={preset} onChange={(v) => setPreset(v as Preset)} options={["square","portrait","story"]} />
            </div>
          </Fieldset>

          <div className="flex gap-2">
            <button className="px-4 py-2 rounded-2xl border" onClick={generateAndDownload}>G√©n√©rer la fiche (PNG)</button>
            <button className="px-4 py-2 rounded-2xl border" onClick={() => navigator.clipboard.writeText(makeCaption(vehicle, dealerName))}>Copier la l√©gende</button>
          </div>
        </div>

        {/* === Panneau droit (pr√©visualisation) === */}
        <div className="space-y-3">
          <div className="text-sm text-gray-500">Pr√©visualisation ({PRESETS[preset].label})</div>
          <canvas ref={previewRef} className="w-full max-w-[720px] border rounded-xl" />
          {/* Canvas export non visible */}
          <canvas ref={exportRef} className="hidden" />
        </div>
      </div>
    </div>
  );
}

// ========================= Rendu Canvas =========================

interface RenderInput {
  preset: Preset;
  vehicle: VehicleData;
  dealerName: string;
  ribbonText: string;
  theme: Theme;
  logoUrl: string | null;
  photoUrl: string | null;
  focus: { scaleX: number; scaleY: number; offsetY: number };
  status: "aucun" | "R√âSERV√â" | "VENDU";
}

async function renderSheet(canvas: HTMLCanvasElement, data: RenderInput) {
  const { preset, vehicle, dealerName, ribbonText, theme, logoUrl, photoUrl, focus, status } = data;
  const { w: outW, h: outH } = PRESETS[preset];
  const ctx = canvas.getContext("2d");
  if (!ctx) return;

  const bgColor = theme.textDark ? "#FFFFFF" : "#0B0B0B";
  const fgColor = theme.textDark ? "#111827" : "#F9FAFB";
  const subColor = theme.textDark ? "#4B5563" : "#D1D5DB";

  ctx.clearRect(0, 0, outW, outH);
  ctx.fillStyle = bgColor;
  ctx.fillRect(0, 0, outW, outH);

  // --- Photo zone ---
  const margin = 48;
  const photoH = Math.round(outH * (preset === "story" ? 0.56 : preset === "portrait" ? 0.52 : 0.56));
  const photoRect = { x: margin, y: margin, w: outW - 2 * margin, h: photoH };

  // Photo: blurred background + sharp elliptical focus.
  if (photoUrl) {
    const img = await loadBitmap(photoUrl);
    if (img) {
      const { sx, sy, sW, sH } = fitCover(img.w, img.h, photoRect.w, photoRect.h);

      // 1) BLUR background
      ctx.save();
      drawRoundRect(ctx, photoRect.x, photoRect.y, photoRect.w, photoRect.h, 28);
      ctx.clip();
      (ctx as any).filter = "blur(26px)"; // Pourquoi: filtre canvas natif, performant sur iOS modernes
      ctx.drawImage(img.bmp as any, sx, sy, sW, sH, photoRect.x, photoRect.y, photoRect.w, photoRect.h);
      (ctx as any).filter = "none";

      // 2) SHARP ellipse on top
      const cx = photoRect.x + photoRect.w / 2;
      const cy = photoRect.y + photoRect.h * (0.5 + focus.offsetY);
      const rx = (photoRect.w / 2) * focus.scaleX;
      const ry = (photoRect.h / 2) * focus.scaleY;
      ctx.save();
      ctx.beginPath();
      // ellipse path
      ctx.ellipse(cx, cy, rx, ry, 0, 0, Math.PI * 2);
      ctx.clip();
      ctx.drawImage(img.bmp as any, sx, sy, sW, sH, photoRect.x, photoRect.y, photoRect.w, photoRect.h);
      ctx.restore();

      // 3) Subtle top gradient for legibility
      const g = ctx.createLinearGradient(0, photoRect.y, 0, photoRect.y + 160);
      g.addColorStop(0, theme.textDark ? "rgba(0,0,0,0.35)" : "rgba(0,0,0,0.15)");
      g.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = g;
      ctx.fillRect(photoRect.x, photoRect.y, photoRect.w, Math.min(photoRect.h, 160));

      ctx.restore();
    }
  } else {
    // Placeholder si pas de photo
    ctx.save();
    drawRoundRect(ctx, photoRect.x, photoRect.y, photoRect.w, photoRect.h, 28);
    ctx.clip();
    const g = ctx.createLinearGradient(0, photoRect.y, 0, photoRect.y + photoRect.h);
    g.addColorStop(0, "#E5E7EB");
    g.addColorStop(1, "#F3F4F6");
    ctx.fillStyle = g;
    ctx.fillRect(photoRect.x, photoRect.y, photoRect.w, photoRect.h);
    ctx.restore();
  }

  // --- Logo + Dealer ---
  const topPad = 24;
  if (logoUrl) {
    const logo = await loadBitmap(logoUrl);
    if (logo) {
      const maxW = 220, maxH = 72;
      const fit = Math.min(maxW / logo.w, maxH / logo.h, 1);
      const lw = Math.round(logo.w * fit);
      const lh = Math.round(logo.h * fit);
      const lx = photoRect.x + topPad;
      const ly = photoRect.y + topPad;
      ctx.save();
      ctx.globalAlpha = 0.95;
      drawRoundRect(ctx, lx - 16, ly - 12, lw + 32, lh + 24, 14);
      ctx.fillStyle = theme.textDark ? "rgba(255,255,255,0.8)" : "rgba(0,0,0,0.35)";
      ctx.fill();
      ctx.globalAlpha = 1;
      ctx.drawImage(logo.bmp as any, lx, ly, lw, lh);
      ctx.restore();
    }
  } else {
    // Monogramme AD si pas de logo
    const lx = photoRect.x + topPad;
    const ly = photoRect.y + topPad;
    const s = 72;
    ctx.save();
    drawRoundRect(ctx, lx - 12, ly - 12, s + 24, s + 24, 14);
    ctx.fillStyle = theme.textDark ? "rgba(255,255,255,0.85)" : "rgba(0,0,0,0.35)";
    ctx.fill();
    ctx.fillStyle = theme.primary;
    ctx.font = "800 56px Inter, ui-sans-serif, system-ui";
    ctx.textBaseline = "top";
    ctx.fillText("AD", lx + 6, ly + 2);
    ctx.restore();
  }

  // --- Price blob ---
  const price = formatPriceEUR(vehicle.price);
  if (price) {
    const pw = 360, ph = 160;
    const px = photoRect.x + photoRect.w - pw - 16;
    const py = photoRect.y + photoRect.h - ph - 16;
    ctx.save();
    drawPaintBlob(ctx, px, py, pw, ph, 1.2);
    ctx.fillStyle = theme.primary;
    ctx.fill();
    ctx.fillStyle = "#111827";
    ctx.font = "900 56px Inter, ui-sans-serif, system-ui";
    ctx.fillText(price, px + 36, py + ph / 2 + 18);
    ctx.restore();
  }

  // --- Status text over photo ---
  if (status !== "aucun") {
    drawStatus(ctx, status, photoRect, theme.primary);
  }

  // --- Title & sub ---
  const titleY = photoRect.y + photoRect.h + 48;
  ctx.fillStyle = fgColor;
  ctx.font = "800 64px Inter, ui-sans-serif, system-ui";
  ctx.fillText(`${vehicle.make} ${vehicle.model}`.trim(), margin, titleY);

  ctx.fillStyle = subColor;
  ctx.font = "600 36px Inter, ui-sans-serif, system-ui";
  const versionY = titleY + 48;
  ctx.fillText(vehicle.version, margin, versionY);
  const featuresY = versionY + 42;
  ctx.font = "500 34px Inter, ui-sans-serif, system-ui";
  ctx.fillText(vehicle.features.split("/").join("/"), margin, featuresY);

  // --- Specs row ---
  const specsY = featuresY + 58;
  ctx.fillStyle = subColor;
  ctx.font = "600 34px Inter, ui-sans-serif, system-ui";
  const specs = [
    `üìÖ ${vehicle.year}`,
    `‚öôÔ∏è ${vehicle.gearbox}`,
    `‚õΩÔ∏è ${vehicle.fuel}`,
    `üêé ${vehicle.power} ch`,
    `üß≠ ${formatKm(vehicle.mileage)}`,
  ].join("   ‚Ä¢   ");
  ctx.fillText(specs, margin, specsY);

  // Divider
  ctx.strokeStyle = theme.textDark ? "#E5E7EB" : "#1F2937";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(margin, specsY + 18);
  ctx.lineTo(outW - margin, specsY + 18);
  ctx.stroke();

  // --- Footer: left dealer, right phone ---
  const footerY = outH - 120;
  ctx.fillStyle = subColor;
  ctx.font = "700 34px Inter, ui-sans-serif, system-ui";
  ctx.fillText(dealerName, margin, footerY);

  const phoneText = `‚òéÔ∏è ${vehicle.phone}`;
  const tw = ctx.measureText(phoneText).width;
  ctx.fillText(phoneText, outW - margin - tw, footerY);

  // --- Bottom ribbon ---
  const ribbonH = 64;
  ctx.fillStyle = theme.ribbonBg;
  ctx.fillRect(0, outH - ribbonH, outW, ribbonH);
  ctx.fillStyle = "#111827";
  ctx.font = "800 28px Inter, ui-sans-serif, system-ui";
  const rw = ctx.measureText(ribbonText).width;
  ctx.fillText(ribbonText, (outW - rw) / 2, outH - ribbonH / 2 + 10);
}

// ========================= Hooks & Helpers =========================

function useFontsReady() {
  const [ready, setReady] = useState(false);
  useEffect(() => {
    (async () => {
      try {
        await (document as any).fonts?.load("700 24px Inter");
        await (document as any).fonts?.ready;
      } catch {}
      setReady(true);
    })();
  }, []);
  return ready;
}

function makeCaption(v: VehicleData, dealer: string) {
  return [
    `${v.make} ${v.model} ${v.year}`,
    `${v.version}`,
    v.features.split("/").join(" ‚Ä¢ "),
    `üìç ${v.city}`,
    `üí∂ ${formatPriceEUR(v.price)}`,
    `üß≠ ${formatKm(v.mileage)} ‚Ä¢ ‚õΩÔ∏è ${v.fuel} ‚Ä¢ ‚öôÔ∏è ${v.gearbox} ‚Ä¢ üêé ${v.power} ch`,
    `‚òéÔ∏è ${v.phone}`,
    dealer,
    "",
    "#voiture #occasion #garage #instacar #venteauto #caroftheday",
  ].filter(Boolean).join("\n");
}

// ========================= UI Components =========================

function Fieldset({ title, children }: { title: string; children: React.ReactNode }) {
  return (
    <section className="border rounded-2xl p-4">
      <div className="font-semibold mb-3">{title}</div>
      {children}
    </section>
  );
}

function Input({ label, value, onChange }: { label: string; value: string; onChange: (v: string) => void }) {
  return (
    <label className="text-sm">
      <div className="mb-1 text-gray-600">{label}</div>
      <input className="w-full border rounded-xl px-3 py-2" value={value} onChange={(e) => onChange(e.target.value)} />
    </label>
  );
}

function Select({ label, value, onChange, options }: { label: string; value: string; onChange: (v: string) => void; options: string[] }) {
  return (
    <label className="text-sm">
      <div className="mb-1 text-gray-600">{label}</div>
      <select className="w-full border rounded-xl px-3 py-2 bg-white" value={value} onChange={(e) => onChange(e.target.value)}>
        {options.map((o) => (
          <option key={o} value={o}>{o}</option>
        ))}
      </select>
    </label>
  );
}

function ColorInput({ label, value, onChange }: { label: string; value: string; onChange: (v: string) => void }) {
  return (
    <label className="text-sm flex items-center gap-3">
      <span className="text-gray-600 min-w-[9rem]">{label}</span>
      <input type="color" value={value} onChange={(e) => onChange(e.target.value)} />
      <input className="flex-1 border rounded-xl px-3 py-2" value={value} onChange={(e) => onChange(e.target.value)} />
    </label>
  );
}

function Slider({ label, value, setValue, min, max, step }: { label: string; value: number; setValue: (n: number) => void; min: number; max: number; step: number }) {
  return (
    <label className="text-sm">
      <div className="mb-1 text-gray-600">{label}</div>
      <input type="range" min={min} max={max} step={step} value={value} onChange={(e) => setValue(parseFloat(e.target.value))} className="w-full" />
    </label>
  );
}

function FileButton({ label, accept, onPick, capture }: { label: string; accept: string; onPick: (f?: File) => void; capture?: boolean }) {
  return (
    <label className="px-3 py-2 rounded-2xl border cursor-pointer">
      {label}
      <input
        type="file"
        accept={accept}
        className="hidden"
        {...(capture ? ({ capture: "environment" } as any) : {})}
        onChange={(e) => onPick(e.target.files?.[0])}
      />
    </label>
  );
}
