<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fiche véhicule Instagram – AD</title>
  <style>
    :root{ --bg:#ffffff; --fg:#111827; --sub:#6b7280; --accent:#E30613; --blue:#073B4C; --pink:#E3006D; }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.4 -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, system-ui; color:var(--fg); background:var(--bg)}
    .wrap{max-width:1200px;margin:0 auto;padding:24px;display:grid;grid-template-columns:410px 1fr;gap:24px}
    @media(max-width:1100px){.wrap{grid-template-columns:1fr}}
    h1{margin:0 0 12px;font-size:24px}
    section{border:1px solid #e5e7eb;border-radius:16px;padding:16px;background:#fff}
    label.txt{display:block;font-size:13px;margin-bottom:8px;color:var(--sub)}
    input[type="text"], select{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{border:1px solid #e5e7eb;border-radius:16px;padding:10px 14px;background:#fff;cursor:pointer}
    .uploader{display:inline-block}
    .uploader input{display:none}
    .small{color:var(--sub);font-size:12px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    canvas{background:#fff;border:1px solid #e5e7eb;border-radius:12px;max-width:100%}
  </style>
</head>
<body>
  <div class="wrap">
    <div>
      <h1>Fiche véhicule Instagram</h1>

      <section>
        <div class="actions">
          <label class="uploader btn">Prendre une photo (iPhone)
            <input id="photoCam" type="file" accept="image/*" capture="environment" />
          </label>
          <label class="uploader btn">Importer une photo
            <input id="photoFile" type="file" accept="image/*" />
          </label>
          <label class="uploader btn">Logo AD (PNG/SVG)
            <input id="logoFile" type="file" accept="image/*,.svg" />
          </label>
        </div>
        <div class="small" style="margin-top:6px">Sans logo ⇒ carré rouge « AD » blanc (style AD)</div>
        <div class="row3" style="margin-top:12px">
          <div>
            <label class="txt">Focus largeur</label>
            <input id="focusX" type="range" min="0.4" max="1.1" step="0.01" value="0.78" />
          </div>
          <div>
            <label class="txt">Focus hauteur</label>
            <input id="focusY" type="range" min="0.35" max="1.1" step="0.01" value="0.55" />
          </div>
          <div>
            <label class="txt">Focus position Y</label>
            <input id="focusOff" type="range" min="-0.25" max="0.25" step="0.005" value="0.02" />
          </div>
        </div>
      </section>

      <section>
        <div class="row">
          <div>
            <label class="txt">Marque</label>
            <input id="make" type="text" value="DACIA" />
          </div>
          <div>
            <label class="txt">Modèle</label>
            <input id="model" type="text" value="SANDERO" />
          </div>
          <div>
            <label class="txt">Version / Finition</label>
            <input id="version" type="text" value="1.5 DCI" />
          </div>
          <div>
            <label class="txt">Caractéristiques (– séparés)</label>
            <input id="features" type="text" value="CAMÉRA – GPS – TOIT PANO – CROCHET ATTELAGE" />
          </div>
          <div>
            <label class="txt">Année</label>
            <input id="year" type="text" value="2019" />
          </div>
          <div>
            <label class="txt">Boîte</label>
            <input id="gearbox" type="text" value="MANUELLE" />
          </div>
          <div>
            <label class="txt">Énergie</label>
            <input id="fuel" type="text" value="ESSENCE" />
          </div>
          <div>
            <label class="txt">Puissance (ch)</label>
            <input id="power" type="text" value="110" />
          </div>
          <div>
            <label class="txt">Kilométrage</label>
            <input id="mileage" type="text" value="110000" />
          </div>
          <div>
            <label class="txt">Téléphone</label>
            <input id="phone" type="text" value="05 55 22 00 22" />
          </div>
          <div>
            <label class="txt">Prix (€)</label>
            <input id="price" type="text" value="12000" />
          </div>
        </div>
      </section>

      <section>
        <div>
          <label class="txt">Nom garage</label>
          <input id="dealer" type="text" value="GARAGE LAUMOND" />
        </div>
        <div class="row" style="margin-top:12px">
          <div>
            <label class="txt">Towns (séparées par virgules)</label>
            <input id="towns" type="text" value="LANTEUIL, MEYSSAC, ARGENTAT" />
          </div>
          <div>
            <label class="txt">Statut</label>
            <select id="status">
              <option value="aucun">aucun</option>
              <option value="RÉSERVÉ">RÉSERVÉ</option>
              <option value="VENDU">VENDU</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <div>
            <label class="txt">Format</label>
            <select id="preset">
              <option value="portrait">Portrait 1080×1350</option>
              <option value="square">Carré 1080×1080</option>
              <option value="story">Story 1080×1920</option>
            </select>
          </div>
          <div class="actions" style="align-items:end">
            <button id="btnGen" class="btn">Générer la fiche (PNG)</button>
            <button id="btnCopy" class="btn">Copier la légende</button>
          </div>
        </div>
      </section>
    </div>

    <div>
      <div class="small" id="previewLabel">Prévisualisation</div>
      <canvas id="preview"></canvas>
      <canvas id="export" style="display:none"></canvas>
    </div>
  </div>

<script>
// ====== Data & helpers ======
const PRESETS = { square:{w:1080,h:1080,label:"Carré 1080×1080"}, portrait:{w:1080,h:1350,label:"Portrait 1080×1350"}, story:{w:1080,h:1920,label:"Story 1080×1920"} };
const fr = new Intl.NumberFormat('fr-FR');
const $ = id => document.getElementById(id);
let logoURL=null, photoURL=null;

function fmtPrice(v){ const d=(v||'').replace(/[^0-9]/g,''); return d?fr.format(+d)+" €":""; }
function fmtKm(v){ const d=(v||'').replace(/[^0-9]/g,''); return d?fr.format(+d)+" KMS":""; }
function fitCover(sw,sh,dw,dh){ const sr=sw/sh, dr=dw/dh; if(sr>dr){ const sH=sh, sW=sH*dr, sx=(sw-sW)/2; return {sx,sy:0,sW,sH}; } else { const sW=sw, sH=sW/dr, sy=(sh-sH)/2; return {sx:0,sy,sW,sH}; } }
function rr(ctx,x,y,w,h,r){ const t=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+t,y); ctx.arcTo(x+w,y,x+w,y+h,t); ctx.arcTo(x+w,y+h,x,y+h,t); ctx.arcTo(x,y+h,x,y,t); ctx.arcTo(x,y,x+w,y,t); ctx.closePath(); }
function starburst(ctx,cx,cy,outer,inner,points=16){ ctx.beginPath(); const step=Math.PI/points; for(let i=0;i<2*points;i++){ const r=(i%2===0)?outer:inner; const a=i*step; const x=cx+Math.cos(a)*r; const y=cy+Math.sin(a)*r; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.closePath(); }
function statusDiag(ctx,text,rect,color){ ctx.save(); ctx.translate(rect.x+rect.w/2,rect.y+rect.h/2); ctx.rotate(-Math.PI/12); ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='800 150px system-ui, -apple-system, Segoe UI, Roboto'; ctx.fillStyle=color; ctx.shadowColor='rgba(0,0,0,0.3)'; ctx.shadowBlur=18; ctx.shadowOffsetY=6; ctx.fillText(text,0,0); ctx.restore(); }
function wrap(ctx,txt,x,y,maxW,lh,maxLines){ const wds=(txt||'').split(/\s+/); let line=''; let lines=0; for(let i=0;i<wds.length;i++){ const test=line?line+' '+wds[i]:wds[i]; const w=ctx.measureText(test).width; if(w>maxW&&i>0){ ctx.fillText(line,x,y); y+=lh; lines++; line=wds[i]; if(lines>=maxLines-1) break; } else line=test; } ctx.fillText(line,x,y); }
function loadImg(url){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=url; }); }
function drawBlur(ctx,img,sx,sy,sW,sH,dx,dy,dW,dH,blur=26){ const any=ctx; if(typeof any.filter==='string'){ const prev=any.filter; any.filter=`blur(${blur}px)`; ctx.drawImage(img,sx,sy,sW,sH,dx,dy,dW,dH); any.filter='none'; return; } const tmp=document.createElement('canvas'); const t=tmp.getContext('2d'); const sc=Math.max(8,Math.floor(Math.min(dW,dH)/20)); const tw=Math.max(1,Math.floor(dW/sc)), th=Math.max(1,Math.floor(dH/sc)); tmp.width=tw; tmp.height=th; t.imageSmoothingEnabled=true; t.drawImage(img,sx,sy,sW,sH,0,0,tw,th); ctx.imageSmoothingEnabled=true; ctx.drawImage(tmp,0,0,tw,th,dx,dy,dW,dH); }

// ====== Render ======
async function renderSheet(canvas, data){ const {preset,vehicle,dealerName,towns,logoUrl,photoUrl,focusX,focusY,focusOff,status} = data; const outW=PRESETS[preset].w, outH=PRESETS[preset].h; const ctx=canvas.getContext('2d'); canvas.width=outW; canvas.height=outH; ctx.clearRect(0,0,outW,outH); ctx.fillStyle='#fff'; ctx.fillRect(0,0,outW,outH);

  // Outer border style (bleu foncé)
  const B=10; ctx.lineWidth=B; ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--blue'); ctx.strokeRect(B/2+18, B/2+18, outW-B-36, outH-B-36);

  // Photo container (arrondi XL, ombre douce)
  const M=56; const photoH=Math.round(outH*0.58); const photoRect={x:M, y:M, w:outW-2*M, h:photoH};
  ctx.save(); rr(ctx,photoRect.x,photoRect.y,photoRect.w,photoRect.h,44); ctx.clip();
  if(photoUrl){ const img=await loadImg(photoUrl); const {sx,sy,sW,sH}=fitCover(img.naturalWidth,img.naturalHeight,photoRect.w,photoRect.h); drawBlur(ctx,img,sx,sy,sW,sH,photoRect.x,photoRect.y,photoRect.w,photoRect.h,24); const cx=photoRect.x+photoRect.w/2; const cy=photoRect.y+photoRect.h*(0.5+focusOff); const rx=(photoRect.w/2)*focusX; const ry=(photoRect.h/2)*focusY; ctx.save(); ctx.beginPath(); ctx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2); ctx.clip(); ctx.drawImage(img,sx,sy,sW,sH,photoRect.x,photoRect.y,photoRect.w,photoRect.h); ctx.restore(); } else { const g=ctx.createLinearGradient(0,photoRect.y,0,photoRect.y+photoRect.h); g.addColorStop(0,'#e5e7eb'); g.addColorStop(1,'#f3f4f6'); ctx.fillStyle=g; ctx.fillRect(photoRect.x,photoRect.y,photoRect.w,photoRect.h);} ctx.restore();
  // Inner shadow-ish
  ctx.save(); rr(ctx,photoRect.x,photoRect.y,photoRect.w,photoRect.h,44); ctx.strokeStyle='rgba(0,0,0,0.08)'; ctx.lineWidth=2; ctx.stroke(); ctx.restore();

  // Logo AD + Garage + towns (en haut gauche dans la photo)
  const pad=26; const lx=photoRect.x+pad, ly=photoRect.y+pad; if(logoUrl){ const logo=await loadImg(logoUrl); const maxW=140, maxH=52; const f=Math.min(maxW/logo.naturalWidth,maxH/logo.naturalHeight,1); const lw=Math.round(logo.naturalWidth*f), lh=Math.round(logo.naturalHeight*f); ctx.drawImage(logo, lx, ly, lw, lh); drawDealer(ctx, lx+lw+16, ly+6, dealerName, towns); } else { // fake AD badge
    const s=64; ctx.save(); rr(ctx,lx,ly,s,s,12); ctx.fillStyle=get('--accent'); ctx.fill(); ctx.fillStyle='#fff'; ctx.font='800 40px system-ui,-apple-system,Segoe UI,Roboto'; ctx.textBaseline='middle'; ctx.textAlign='center'; ctx.fillText('AD', lx+s/2, ly+s/2+2); ctx.restore(); drawDealer(ctx, lx+s+16, ly+6, dealerName, towns); }

  // Price starburst (en bas droite de l'image)
  const starCX = photoRect.x + photoRect.w - 150; const starCY = photoRect.y + photoRect.h - 50; ctx.save(); starburst(ctx, starCX, starCY, 110, 60, 14); ctx.fillStyle=get('--accent'); ctx.fill(); ctx.fillStyle='#fff'; ctx.font='900 40px system-ui,-apple-system,Segoe UI,Roboto'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(fmtPrice(vehicle.price), starCX, starCY+2); ctx.restore();

  // Titre et textes
  const titleY=photoRect.y+photoRect.h+34; ctx.fillStyle='#111827'; ctx.font='900 66px system-ui,-apple-system,Segoe UI,Roboto'; ctx.fillText((vehicle.make+' '+vehicle.model).toUpperCase(), M, titleY);
  const vY=titleY+44; ctx.font='700 34px system-ui,-apple-system,Segoe UI,Roboto'; ctx.fillText((vehicle.version||'').toUpperCase(), M, vY);
  const fY=vY+42; ctx.font='800 30px system-ui,-apple-system,Segoe UI,Roboto'; wrap(ctx, (vehicle.features||'').toUpperCase(), M, fY, outW-2*M, 36, 2);

  // Specs (ligne icônes simplifiées)
  const sY=fY+60; ctx.font='600 30px system-ui,-apple-system,Segoe UI,Roboto'; ctx.fillStyle=get('--sub'); const specs=[vehicle.year, vehicle.gearbox, vehicle.fuel, vehicle.power+' ch', fmtKm(vehicle.mileage)]; const join='  •  '; const txt=specs.filter(Boolean).join(join); ctx.fillText(txt, M, sY);

  // Footer: phone pill (en bas droite)
  const footerY=outH-96; const phone=' '+(vehicle.phone||''); ctx.font='800 34px system-ui,-apple-system,Segoe UI,Roboto'; const tw=ctx.measureText(phone).width; const px=outW-M- (tw+80); const py=footerY-36; const pw=tw+80; const ph=56; rr(ctx,px,py,pw,ph,28); ctx.fillStyle=get('--pink'); ctx.fill(); ctx.fillStyle='#fff'; ctx.fillText(phone, px+56, footerY); // pictogramme
  ctx.beginPath(); ctx.arc(px+30, py+ph/2, 10, 0, Math.PI*2); ctx.fillStyle='#fff'; ctx.fill();

  // Statut (si choisi)
  if(status!=='aucun') statusDiag(ctx, status, photoRect, get('--accent'));
}

function drawDealer(ctx, x, y, dealer, townsCSV){ ctx.fillStyle='#111827'; ctx.font='700 22px system-ui,-apple-system,Segoe UI,Roboto'; ctx.fillText(dealer||'', x, y+18); const towns=(townsCSV||'').split(',').map(s=>s.trim()).filter(Boolean); ctx.font='700 16px system-ui,-apple-system,Segoe UI,Roboto'; let cx=x, base=y+42; towns.forEach((t,i)=>{ const w=ctx.measureText(t).width; ctx.fillStyle='#1f2937'; ctx.fillText(t, cx, base); ctx.strokeStyle='#1f2937'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(cx, base+4); ctx.lineTo(cx+w, base+4); ctx.stroke(); cx += w + 16; }); }
function get(name){ return getComputedStyle(document.documentElement).getPropertyValue(name) || '#000'; }

// ====== State + bindings ======
const state={ preset:'portrait', status:'aucun', focusX:0.78, focusY:0.55, focusOff:0.02, dealerName: $('dealer').value, towns: $('towns').value, vehicle: { make:$('make').value, model:$('model').value, version:$('version').value, features:$('features').value, year:$('year').value, gearbox:$('gearbox').value, fuel:$('fuel').value, mileage:$('mileage').value, power:$('power').value, price:$('price').value, phone:$('phone').value } };

function bind(){ const map=[ ['make','vehicle.make'], ['model','vehicle.model'], ['version','vehicle.version'], ['features','vehicle.features'], ['year','vehicle.year'], ['gearbox','vehicle.gearbox'], ['fuel','vehicle.fuel'], ['power','vehicle.power'], ['mileage','vehicle.mileage'], ['price','vehicle.price'], ['phone','vehicle.phone'], ['dealer','dealerName'], ['towns','towns'] ]; map.forEach(([id,path])=>$(id).addEventListener('input',()=>{ set(path,$(id).value); schedule(); })); $('preset').addEventListener('change', ()=>{ state.preset=$('preset').value; schedule(); }); $('status').addEventListener('change', ()=>{ state.status=$('status').value; schedule(); }); ['focusX','focusY','focusOff'].forEach(id=>$(id).addEventListener('input',()=>{ state[id]=$('#'+id).value*1; schedule(); }));
  $('logoFile').addEventListener('change', e=>{ const f=e.target.files&&e.target.files[0]; if(!f||!f.type.startsWith('image/')) return; if(logoURL) URL.revokeObjectURL(logoURL); logoURL=URL.createObjectURL(f); schedule(); });
  const pickPhoto=e=>{ const f=e.target.files&&e.target.files[0]; if(!f||!f.type.startsWith('image/')) return; if(photoURL) URL.revokeObjectURL(photoURL); photoURL=URL.createObjectURL(f); schedule(); };
  $('photoFile').addEventListener('change', pickPhoto); $('photoCam').addEventListener('change', pickPhoto);
  $('btnGen').addEventListener('click', async ()=>{ const c=$('export'); await renderSheet(c, { ...state, logoUrl:logoURL, photoUrl:photoURL }); const ios=/iPad|iPhone|iPod/.test(navigator.userAgent); c.toBlob(b=>{ if(!b) return; const url=URL.createObjectURL(b); if(ios) window.open(url,'_blank'); else { const a=document.createElement('a'); const fn=`${state.vehicle.make}-${state.vehicle.model}-${state.vehicle.year}-${state.preset}`.replace(/[^a-z0-9-_]+/gi,'-'); a.href=url; a.download=fn+'.png'; document.body.appendChild(a); a.click(); a.remove(); } setTimeout(()=>URL.revokeObjectURL(url),1200); },'image/png'); });
  $('btnCopy').addEventListener('click', ()=>{ navigator.clipboard.writeText(makeCaption(state.vehicle, state.dealerName, state.towns)); });
}
function set(path,val){ const ps=path.split('.'); let cur=state; for(let i=0;i<ps.length-1;i++) cur=cur[ps[i]]; cur[ps.at(-1)]=val; }

let raf=null; function schedule(){ if(raf) cancelAnimationFrame(raf); raf=requestAnimationFrame(drawPreview); }
async function drawPreview(){ const c=$('preview'); const dims=PRESETS[state.preset]; $('previewLabel').textContent='Prévisualisation ('+dims.label+')'; const r=0.38; c.width=Math.round(dims.w*r); c.height=Math.round(dims.h*r); const off=document.createElement('canvas'); off.width=dims.w; off.height=dims.h; await renderSheet(off, { ...state, logoUrl:logoURL, photoUrl:photoURL }); const ctx=c.getContext('2d'); ctx.drawImage(off,0,0,c.width,c.height); }

function makeCaption(v, dealer, towns){ return [ `${v.make} ${v.model} ${v.year}`, v.version, v.features, `Prix: ${fmtPrice(v.price)}`, `${v.fuel} • ${v.gearbox} • ${v.power}ch • ${fmtKm(v.mileage)}`, `${dealer} – ${towns}` ].filter(Boolean).join('\n'); }

bind(); schedule();
</script>
</body>
</html>
