<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Fiche V√©hicule ‚Äì Garage Laumond</title>
<style>
  :root{
    --bg:#0f0f10; --panel:#151518; --text:#fff; --muted:#cbd5e1; --accent:#e11d2e;
    --chip:#111; --ring:rgba(255,255,255,.1);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Arial}
  a{color:inherit}
  .wrap{max-width:980px;margin:28px auto;padding:16px}
  .card{background:var(--panel);border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1{font-size:22px;margin:0 0 8px}
  label{display:block;font-size:13px;margin:6px 0 4px;color:var(--muted)}
  input,select{width:100%;padding:11px;border-radius:10px;border:1px solid #30333a;background:#0f1114;color:#e6e7ea}
  .grid{display:grid;gap:10px}
  .g2{grid-template-columns:repeat(2,minmax(0,1fr))} .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .btn{display:inline-block;background:var(--accent);padding:12px 16px;border-radius:12px;font-weight:700;border:0;color:#fff}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .preview{width:100%;max-width:580px;aspect-ratio:1/1;border-radius:12px;overflow:hidden;border:1px solid var(--ring);background:#000}
  .preview img{width:100%;height:100%;object-fit:contain}
  small{color:var(--muted)}
  .range{width:100%}
  .toolbar{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
  .pill{background:#0f1114;border:1px solid #272a31;border-radius:999px;padding:8px 12px}
  .footer-tip{opacity:.6;text-align:center;margin:10px 0}
</style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>G√©n√©rateur de fiche ‚Äì Garage Laumond</h1>

      <div class="grid g2">
        <div>
          <label>Photo du v√©hicule</label>
          <input id="photo" type="file" accept="image/*" capture="environment" />
        </div>
        <div>
          <label>Logo (optionnel)</label>
          <input id="logo" type="file" accept="image/*" />
        </div>
      </div>

      <div class="grid g3">
        <div><label>Marque</label><input id="marque" placeholder="Renault" /></div>
        <div><label>Mod√®le</label><input id="modele" placeholder="Captur" /></div>
        <div><label>Finition</label><input id="finition" placeholder="Intens" /></div>
      </div>

      <div class="grid g3">
        <div><label>Motorisation</label><input id="motorisation" placeholder="1.5 dCi 90" /></div>
        <div><label>Ann√©e</label><input id="annee" inputmode="numeric" placeholder="2018" /></div>
        <div><label>Kilom√©trage</label><input id="km" inputmode="numeric" placeholder="149000" /></div>
      </div>

      <div class="grid g3">
        <div>
          <label>Carburant</label>
          <select id="carburant">
            <option>Diesel</option><option>Essence</option><option>Hybride</option><option>√âlectrique</option><option>GPL</option>
          </select>
        </div>
        <div>
          <label>Bo√Æte</label>
          <select id="boite">
            <option>Manuelle</option><option>Automatique</option>
          </select>
        </div>
        <div><label>Prix (‚Ç¨)</label><input id="prix" inputmode="numeric" placeholder="12990" /></div>
      </div>

      <div class="grid g2">
        <div><label>T√©l√©phone</label><input id="tel" placeholder="06 00 00 00 00" /></div>
        <div><label>Nom / Garage</label><input id="garage" placeholder="GARAGE LAUMOND ‚Äì LANTEUIL ‚Ä¢ MEYSSAC ‚Ä¢ ARGENTAT" /></div>
      </div>

      <div>
        <label>Options (s√©par√©es par des virgules)</label>
        <input id="options" placeholder="Toit pano, Cam√©ra 360¬∞, Si√®ges chauffants" />
      </div>

      <div class="card">
        <h1 style="margin-bottom:6px">Recadrage photo (zone fixe)</h1>
        <div class="row">
          <canvas id="crop" class="preview" width="540" height="540" style="max-width:540px"></canvas>
          <div style="flex:1;min-width:220px">
            <div class="toolbar">
              <span class="pill">Zoom</span>
              <input id="z" class="range" type="range" min="100" max="300" step="1" value="160" />
            </div>
            <div class="toolbar">
              <span class="pill">Pan X</span>
              <input id="px" class="range" type="range" min="-100" max="100" step="1" value="0" />
            </div>
            <div class="toolbar">
              <span class="pill">Pan Y</span>
              <input id="py" class="range" type="range" min="-100" max="100" step="1" value="0" />
            </div>
            <small>Le cadre repr√©sente la zone photo finale (1080√ó560). Tout autour est flout√© automatiquement.</small>
          </div>
        </div>
      </div>

      <div class="row" style="justify-content:space-between;align-items:center">
        <button id="generate" class="btn">G√©n√©rer la fiche</button>
        <a id="download" class="btn" download style="display:none">üì• T√©l√©charger l'image</a>
      </div>
      <p class="footer-tip">Astuce : ajoute cette page √† l‚Äô√©cran d‚Äôaccueil pour l‚Äôutiliser comme une mini-app.</p>
    </section>

    <section class="card">
      <h1>Aper√ßu export</h1>
      <div class="preview"><img id="preview" alt="aper√ßu" /></div>
    </section>
  </main>

<script>
/* ---------- Utilitaires ---------- */
const $=s=>document.querySelector(s);
const fmtEUR = n => new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0})
                   .format(Number(String(n).replace(/[^\d]/g,''))||0);
const fmtKM  = n => new Intl.NumberFormat('fr-FR').format(Number(String(n).replace(/[^\d]/g,''))||0)+' km';

function loadImage(src){return new Promise((res,rej)=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=src})}
function drawCover(ctx,img,x,y,w,h){
  const r=Math.max(w/img.width,h/img.height), nw=img.width*r, nh=img.height*r;
  ctx.drawImage(img, x+(w-nw)/2, y+(h-nh)/2, nw, nh);
}
function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();
}
function wrap(ctx,text,x,y,maxW,lh){
  const words=text.split(/\s+/);let line='', yy=y;
  for(let i=0;i<words.length;i++){
    const test=line+(line?' ':'')+words[i];
    if(ctx.measureText(test).width>maxW && i>0){ctx.fillText(line,x,yy);line=words[i];yy+=lh}
    else line=test;
  }
  ctx.fillText(line,x,yy);
  return yy;
}

/* ---------- √âtat ----------- */
let photoData=null, photoImg=null, logoData=null, logoImg=null;
let crop={zoom:1.6, px:0, py:0}; // zoom: 1.0..3.0 ; pan -1..1

/* ---------- Entr√©es ---------- */
$('#photo').addEventListener('change', async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  photoData=await new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(f)});
  photoImg=await loadImage(photoData);
  drawCrop();
});
$('#logo').addEventListener('change', async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  logoData=await new Promise((res,rej)=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(f)});
  logoImg=await loadImage(logoData);
});

['z','px','py'].forEach(id=>{
  $('#'+id).addEventListener('input',()=>{
    if(id==='z') crop.zoom = Number($('#z').value)/100;
    if(id==='px') crop.px   = Number($('#px').value)/100;
    if(id==='py') crop.py   = Number($('#py').value)/100;
    drawCrop();
  });
});

/* ---------- Canvas de recadrage (aper√ßu) ---------- */
const cropCanvas=$('#crop'), cctx=cropCanvas.getContext('2d');
function drawCrop(){
  const W=cropCanvas.width, H=cropCanvas.height;
  cctx.clearRect(0,0,W,H);
  cctx.fillStyle='#000';cctx.fillRect(0,0,W,H);

  // cadre 540 preview ‚Üí zone utile 540√ó280
  const PAD=20;
  const frameW=W-2*PAD, frameH=Math.round((560/1080)*W)-2; // garde m√™me ratio que l'export
  const fx=PAD, fy= (H-frameH)/2;
  cctx.save();
  // fond flou
  if(photoImg){
    cctx.filter='blur(15px)'; drawCover(cctx,photoImg,0,0,W,H); cctx.filter='none';
    // masque pour zone
    cctx.fillStyle='rgba(0,0,0,.65)';
    cctx.fillRect(0,0,W,H);
    cctx.clearRect(fx,fy,frameW,frameH);

    // image nette recadr√©e (m√™mes maths que l'export)
    const z=crop.zoom; const iw=photoImg.width, ih=photoImg.height;
    const baseScale=Math.max(frameW/iw, frameH/ih);
    const scale=baseScale*z, tw=iw*scale, th=ih*scale;
    const ox = fx + (frameW - tw)/2 + crop.px*(frameW/2);
    const oy = fy + (frameH - th)/2 + crop.py*(frameH/2);
    cctx.save();
    cctx.beginPath(); cctx.rect(fx,fy,frameW,frameH); cctx.clip();
    cctx.drawImage(photoImg, ox, oy, tw, th);
    cctx.restore();
  }else{
    cctx.fillStyle='#111';cctx.fillRect(fx,fy,frameW,frameH);
    cctx.fillStyle='#999';cctx.font='600 16px system-ui';cctx.textAlign='center';cctx.textBaseline='middle';
    cctx.fillText('Importer une photo‚Ä¶', W/2, H/2);
  }
  cctx.strokeStyle='rgba(255,255,255,.35)';cctx.lineWidth=2; cctx.strokeRect(fx+.5,fy+.5,frameW-1,frameH-1);
  cctx.restore();
}

/* ---------- Export 1080√ó1080 ---------- */
async function generate(){
  const W=1080,H=1080, PAD=36;
  const canvas=document.createElement('canvas'); canvas.width=W; canvas.height=H;
  const ctx=canvas.getContext('2d');

  // fond
  ctx.fillStyle='#0c0c0e'; ctx.fillRect(0,0,W,H);

  // --- bandeau haut (logo + nom) ---
  const topH=130;
  ctx.fillStyle='rgba(255,255,255,.06)'; roundRect(ctx,24,24,W-48,topH,18); ctx.fill();

  let lx=48, ly=38;
  if(logoImg){
    // logo align√© au texte
    const targetH=64, ratio=logoImg.width/logoImg.height, lw=targetH*ratio;
    ctx.drawImage(logoImg, lx, ly, lw, targetH);
    lx += lw + 18;
  }
  ctx.fillStyle='#fff';
  ctx.font='800 40px system-ui,-apple-system,Segoe UI,Arial'; ctx.textBaseline='top';
  const garageText = ($('#garage').value||'GARAGE LAUMOND ‚Äì LANTEUIL ‚Ä¢ MEYSSAC ‚Ä¢ ARGENTAT');
  ctx.fillText(garageText, lx, ly+2);
  ctx.font='700 22px system-ui,-apple-system,Segoe UI,Arial';
  ctx.globalAlpha=.85; ctx.fillText('', lx, ly+48); ctx.globalAlpha=1;

  // --- zone photo ---
  const frameX=PAD, frameY=topH+48, frameW=W-PAD*2, frameH=560;
  if(photoImg){
    // flou global
    ctx.filter='blur(25px)'; drawCover(ctx,photoImg,0,topH, W, H-topH-160); ctx.filter='none';
    // fond assombri sous la photo
    roundRect(ctx,frameX,frameY,frameW,frameH,18); ctx.fillStyle='rgba(0,0,0,.45)'; ctx.fill();

    // image nette recadr√©e (m√™mes maths que preview)
    const z=crop.zoom, iw=photoImg.width, ih=photoImg.height;
    const baseScale=Math.max(frameW/iw, frameH/ih);
    const scale=baseScale*z, tw=iw*scale, th=ih*scale;
    const ox = frameX + (frameW - tw)/2 + crop.px*(frameW/2);
    const oy = frameY + (frameH - th)/2 + crop.py*(frameH/2);
    ctx.save(); roundRect(ctx,frameX,frameY,frameW,frameH,18); ctx.clip();
    ctx.drawImage(photoImg, ox, oy, tw, th);
    ctx.restore();
  }else{
    ctx.fillStyle='#111'; roundRect(ctx,frameX,frameY,frameW,frameH,18); ctx.fill();
  }

  // --- textes bas sur la photo ---
  const titleY = frameY + frameH - 150;
  ctx.fillStyle='#fff'; ctx.textAlign='left'; ctx.textBaseline='alphabetic';
  ctx.font='900 72px system-ui,-apple-system,Segoe UI,Arial';
  const tBrand = ($('#marque').value||'MARQUE').toUpperCase();
  const tModel = ($('#modele').value||'MOD√àLE').toUpperCase();
  ctx.fillText(`${tBrand} ${tModel}`, frameX+24, titleY);

  ctx.font='600 32px system-ui,-apple-system,Segoe UI,Arial';
  ctx.globalAlpha=.95;
  const sub = [$('#motorisation').value,$('#finition').value].filter(Boolean).join('  ¬∑  ') || 'Motorisation  ¬∑  Finition';
  ctx.fillText(sub, frameX+24, titleY+40);
  ctx.globalAlpha=1;

  ctx.font='700 30px system-ui,-apple-system,Segoe UI,Arial';
  const specY=titleY+86;
  const specs=[
    `üìÖ ${$('#annee').value||'2018'}`,
    `üöó ${$('#km').value?fmtKM($('#km').value):'149 000 km'}`,
    `üõ¢ ${$('#carburant').value}`,
    `‚öôÔ∏è ${$('#boite').value}`
  ].join('      ');
  ctx.fillText(specs, frameX+24, specY);

  ctx.font='400 26px system-ui,-apple-system,Segoe UI,Arial';
  ctx.globalAlpha=.9;
  const opsRaw=($('#options').value||'').trim();
  const ops = opsRaw
    ? opsRaw.split(',').map(s=>'‚Ä¢ '+s.trim()).join('   ')
    : '‚Ä¢ Toit pano   ‚Ä¢ Cam√©ra 360¬∞   ‚Ä¢ Si√®ges chauffants';
  wrap(ctx, ops, frameX+24, specY+34, frameW-48, 32);
  ctx.globalAlpha=1;

  // --- barre basse : t√©l√©phone + bulle prix rouge ---
  const barY = H-140, barH=90;
  roundRect(ctx,24, barY, W-48, barH, 18); ctx.fillStyle='#0f1114'; ctx.fill();

  ctx.font='800 44px system-ui,-apple-system,Segoe UI,Arial';
  ctx.fillStyle='#fff'; ctx.textAlign='left'; ctx.fillText($('#tel').value||'06 00 00 00 00', 46, barY+60);

  const priceText = ($('#prix').value?fmtEUR($('#prix').value):'');
  if(priceText){
    const pw = Math.max(360, ctx.measureText(priceText).width+80), ph=74, pr=20;
    const px = W - 24 - pw, py = barY + (barH-ph)/2;
    ctx.fillStyle='#e11d2e'; roundRect(ctx,px,py,pw,ph,pr); ctx.fill();
    ctx.fillStyle='#fff'; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font='900 42px system-ui,-apple-system,Segoe UI,Arial';
    ctx.fillText(priceText, px+pw/2, py+ph/2+2);
  }

  // --- export ---
  const dataUrl=canvas.toDataURL('image/jpeg', .94);
  $('#preview').src=dataUrl;
  const a=$('#download'); a.href=dataUrl; a.download='fiche_garage_laummond.jpg'; a.style.display='inline-block';
}

$('#generate').addEventListener('click', generate);
drawCrop(); // premi√®re vue
</script>
</body>
</html>
