<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fiche véhicule Instagram – AD</title>
  <style>
    :root{ --bg:#ffffff; --fg:#0f172a; --sub:#475569; --muted:#e2e8f0; --ad-red:#E30613; --ad-blue:#001E62; }
    *{box-sizing:border-box}
    body{margin:0;font:16px/1.45 ui-sans-serif,-apple-system,Segoe UI,Roboto,system-ui;color:var(--fg);background:var(--bg)}
    .wrap{max-width:1200px;margin:0 auto;padding:24px;display:grid;grid-template-columns:420px 1fr;gap:24px}
    @media(max-width:1100px){.wrap{grid-template-columns:1fr}}
    h1{margin:0 0 12px;font-size:24px}
    section{border:1px solid var(--muted);border-radius:16px;padding:16px;background:#fff}
    label.txt{display:block;font-size:13px;margin-bottom:8px;color:var(--sub)}
    input[type="text"],select{width:100%;padding:10px 12px;border:1px solid var(--muted);border-radius:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .btn{border:1px solid var(--muted);border-radius:16px;padding:10px 14px;background:#fff;cursor:pointer}
    .uploader{display:inline-block}.uploader input{display:none}
    .small{color:var(--sub);font-size:12px}
    canvas{background:#fff;border:1px solid var(--muted);border-radius:12px;max-width:100%}
    /* Barre mobile fixée sous l’aperçu */
    #controls{position:relative}
    @media(max-width:820px){#controls{position:fixed;left:0;right:0;bottom:0;z-index:20;background:#fff;border-top:1px solid var(--muted);padding:10px 12px}body{padding-bottom:170px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div>
      <h1>Fiche véhicule Instagram</h1>

      <section>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <label class="uploader btn">Prendre une photo (iPhone)
            <input id="photoCam" type="file" accept="image/*" capture="environment" />
          </label>
          <label class="uploader btn">Importer une photo
            <input id="photoFile" type="file" accept="image/*" />
          </label>
          <label class="uploader btn">Logo AD (PNG/SVG)
            <input id="logoFile" type="file" accept="image/*,.svg" />
          </label>
        </div>
        <div class="small" style="margin-top:6px">Par défaut : <b>AD Expert</b> intégré ci‑dessous (remplaçable via le bouton).</div>
      </section>

      <section>
        <div class="row">
          <div><label class="txt">Marque</label><input id="make" type="text" value="DACIA" /></div>
          <div><label class="txt">Modèle</label><input id="model" type="text" value="SANDERO" /></div>
          <div><label class="txt">Version / Finition</label><input id="version" type="text" value="1.5 DCI" /></div>
          <div><label class="txt">Caractéristiques (– séparés)</label><input id="features" type="text" value="CAMÉRA – GPS – TOIT PANO – CROCHET ATTELAGE" /></div>
          <div><label class="txt">Année</label><input id="year" type="text" value="2019" /></div>
          <div><label class="txt">Boîte</label><input id="gearbox" type="text" value="MANUELLE" /></div>
          <div><label class="txt">Énergie</label><input id="fuel" type="text" value="ESSENCE" /></div>
          <div><label class="txt">Puissance (ch)</label><input id="power" type="text" value="110" /></div>
          <div><label class="txt">Kilométrage</label><input id="mileage" type="text" value="110000" /></div>
          <div><label class="txt">Téléphone</label><input id="phone" type="text" value="05 55 22 00 22" /></div>
          <div><label class="txt">Prix (€)</label><input id="price" type="text" value="12000" /></div>
        </div>
      </section>

      <section>
        <div><label class="txt">Nom garage</label><input id="dealer" type="text" value="GARAGE LAUMOND – Lanteuil • Meyssac • Argentat" /></div>
        <div class="row3" style="margin-top:12px">
          <div><label class="txt">Statut</label><select id="status"><option value="aucun">aucun</option><option value="RÉSERVÉ">RÉSERVÉ</option><option value="VENDU">VENDU</option></select></div>
          <div><label class="txt">Format</label><select id="preset"><option value="portrait">Portrait 1080×1350</option><option value="square">Carré 1080×1080</option><option value="story">Story 1080×1920</option></select></div>
        </div>
      </section>
    </div>

    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div class="small" id="previewLabel">Prévisualisation</div>
        <div style="display:flex;gap:8px"><button id="btnGen" class="btn">Télécharger PNG</button></div>
      </div>
      <canvas id="preview"></canvas>
      <canvas id="export" style="display:none"></canvas>

      <section id="controls" style="margin-top:12px">
        <div class="row3">
          <div><label class="txt">Focus largeur</label><input id="focusX" type="range" min="0.5" max="1.1" step="0.01" value="0.82" /></div>
          <div><label class="txt">Focus hauteur</label><input id="focusY" type="range" min="0.45" max="1.1" step="0.01" value="0.60" /></div>
          <div><label class="txt">Position verticale</label><input id="focusOff" type="range" min="-0.25" max="0.25" step="0.005" value="0.00" /></div>
        </div>
        <div class="small" style="margin-top:6px">iPhone : la barre reste en bas, l’aperçu se met à jour <b>en direct</b> lorsque tu glisses.</div>
      </section>
    </div>
  </div>

<script>
/* ====== Logo AD Expert intégré (base64) ====== */
const DEFAULT_LOGO = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAEkCAYAAAAB5GevAAAQAElEQVR4Aey9CZwdVbXvv6jKqZChQ9KJJgwmLZgAElDAK2kU4lQqkq7r4y3cQhS2r3n1jvQvG0c9xJzFhF0S3pQkqkX3/0m6VnJm9..."; // remplacé dans le vrai fichier (canvas) par la version complète

/* ====== Consts & helpers ====== */
const PRESETS = { square:{w:1080,h:1080,label:"Carré 1080×1080"}, portrait:{w:1080,h:1350,label:"Portrait 1080×1350"}, story:{w:1080,h:1920,label:"Story 1080×1920"} };
const $ = (id)=>document.getElementById(id);
const fr = new Intl.NumberFormat('fr-FR');
let logoURL = DEFAULT_LOGO, photoURL = null;

const THEME = { red:'#E30613', blue:'#001E62', fg:'#0f172a', sub:'#475569' };

function price(v){ const d=(v||'').replace(/[^0-9]/g,''); return d?fr.format(+d)+" €":""; }
function kms(v){ const d=(v||'').replace(/[^0-9]/g,''); return d?fr.format(+d)+" KMS":""; }
function fitCover(sw,sh,dw,dh){ const sr=sw/sh, dr=dw/dh; if(sr>dr){ const sH=sh, sW=sH*dr, sx=(sw-sW)/2; return {sx,sy:0,sW,sH}; } else { const sW=sw, sH=sW/dr, sy=(sh-sH)/2; return {sx:0,sy,sW,sH}; } }
function rr(ctx,x,y,w,h,r){ const t=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+t,y); ctx.arcTo(x+w,y,x+w,y+h,t); ctx.arcTo(x+w,y+h,x,y+h,t); ctx.arcTo(x,y+h,x,y,t); ctx.arcTo(x,y,x+w,y,t); ctx.closePath(); }
function loadImage(url){ return new Promise((res,rej)=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>res(img); img.onerror=rej; img.src=url; }); }

// Blur fallback (iPhone safe)
function drawBlur(ctx,img,sx,sy,sW,sH,dx,dy,dW,dH,px=26){ const any=ctx; if(typeof any.filter==='string'){ const prev=any.filter; any.filter=`blur(${px}px)`; ctx.drawImage(img,sx,sy,sW,sH,dx,dy,dW,dH); any.filter=prev; return; } const tmp=document.createElement('canvas'); const t=tmp.getContext('2d'); const sc=Math.max(6, Math.floor(Math.min(dW,dH)/18)); const tw=Math.max(1, Math.floor(dW/sc)), th=Math.max(1, Math.floor(dH/sc)); tmp.width=tw; tmp.height=th; t.imageSmoothingEnabled=true; t.drawImage(img,sx,sy,sW,sH,0,0,tw,th); ctx.imageSmoothingEnabled=true; ctx.drawImage(tmp,0,0,tw,th,dx,dy,dW,dH); }

function statusStamp(ctx,txt,rect,color){ ctx.save(); ctx.translate(rect.x+rect.w/2,rect.y+rect.h/2); ctx.rotate(-Math.PI/14); ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font='900 120px system-ui,-apple-system,Segoe UI,Roboto'; ctx.lineWidth=10; ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.lineJoin='round'; ctx.miterLimit=2; ctx.strokeText(txt,0,0); ctx.fillStyle=color; ctx.fillText(txt,0,0); ctx.restore(); }

// Badge prix moderne: superellipse + gradient + lueur
function drawPriceBadge(ctx, x, y, w, h, text){
  const k = 0.55; const rx=w/2, ry=h/2; const cx=x+rx, cy=y+ry;
  ctx.save(); ctx.translate(cx, cy); ctx.rotate(-0.1);
  ctx.beginPath();
  ctx.moveTo(-rx, 0);
  ctx.bezierCurveTo(-rx, -ry*k, -rx*k, -ry, 0, -ry);
  ctx.bezierCurveTo(rx*k, -ry, rx, -ry*k, rx, 0);
  ctx.bezierCurveTo(rx, ry*k, rx*k, ry, 0, ry);
  ctx.bezierCurveTo(-rx*k, ry, -rx, ry*k, -rx, 0);
  const g=ctx.createLinearGradient(-rx,-ry,rx,ry); g.addColorStop(0,'#ff5d6a'); g.addColorStop(1,'#b70014');
  ctx.fillStyle=g; ctx.shadowColor='rgba(0,0,0,0.25)'; ctx.shadowBlur=18; ctx.shadowOffsetY=8; ctx.fill();
  ctx.lineWidth=6; ctx.strokeStyle='rgba(255,255,255,0.95)'; ctx.stroke();
  ctx.beginPath(); ctx.ellipse(-rx*0.25, -ry*0.45, rx*0.35, ry*0.22, -0.2, 0, Math.PI*2);
  ctx.fillStyle='rgba(255,255,255,0.35)'; ctx.fill();
  ctx.shadowColor='transparent'; ctx.fillStyle='#fff'; ctx.font='900 44px system-ui,-apple-system,Segoe UI,Roboto'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(text, 0, 6);
  ctx.restore();
}

/* ====== Render ====== */
async function renderSheet(canvas, data){ const {preset,vehicle,dealerName,logoUrl,photoUrl,focus,status} = data; const outW=PRESETS[preset].w, outH=PRESETS[preset].h; const ctx=canvas.getContext('2d'); canvas.width=outW; canvas.height=outH; ctx.clearRect(0,0,outW,outH); ctx.fillStyle='#fff'; ctx.fillRect(0,0,outW,outH);
  // Bordure fine bleue
  const B=8; ctx.strokeStyle=THEME.blue; ctx.lineWidth=B; ctx.strokeRect(B/2+16, B/2+16, outW-B-32, outH-B-32);
  // Zone photo
  const M=52; const photoH=Math.round(outH*0.56); const photoRect={x:M,y:M,w:outW-2*M,h:photoH};
  ctx.save(); rr(ctx,photoRect.x,photoRect.y,photoRect.w,photoRect.h,28); ctx.clip();
  if(photoUrl){ const img=await loadImage(photoUrl); const {sx,sy,sW,sH}=fitCover(img.naturalWidth,img.naturalHeight,photoRect.w,photoRect.h); drawBlur(ctx,img,sx,sy,sW,sH,photoRect.x,photoRect.y,photoRect.w,photoRect.h,26); const cx=photoRect.x+photoRect.w/2; const cy=photoRect.y+photoRect.h*(0.5+focus.offsetY); const rx=(photoRect.w/2)*focus.scaleX; const ry=(photoRect.h/2)*focus.scaleY; ctx.save(); ctx.beginPath(); ctx.ellipse(cx,cy,rx,ry,0,0,Math.PI*2); ctx.clip(); ctx.drawImage(img,sx,sy,sW,sH,photoRect.x,photoRect.y,photoRect.w,photoRect.h); ctx.restore(); } else { const g=ctx.createLinearGradient(0,photoRect.y,0,photoRect.y+photoRect.h); g.addColorStop(0,'#E5E7EB'); g.addColorStop(1,'#F3F4F6'); ctx.fillStyle=g; ctx.fillRect(photoRect.x,photoRect.y,photoRect.w,photoRect.h);} ctx.restore();
  // Panneau logo + garage (centré verticalement)
  const pad=22; const lx=photoRect.x+pad, ly=photoRect.y+pad; const panelW=Math.min(720, photoRect.w-2*pad); const panelH=64;
  ctx.save(); rr(ctx,lx-14,ly-10,panelW, panelH, 16); ctx.fillStyle='rgba(255,255,255,0.96)'; ctx.fill();
  let textX = lx + 72 + 14; let textY = ly + panelH/2; // défaut si fallback AD
  try{ if(logoUrl){ const logo=await loadImage(logoUrl); const maxH=44; const f=maxH/logo.naturalHeight; const lw=Math.round(logo.naturalWidth*f), lh=Math.round(logo.naturalHeight*f); ctx.drawImage(logo, lx, ly+(panelH-lh)/2, lw, lh); textX = lx + lw + 16; textY = ly + panelH/2; } else { drawADFallback(ctx,lx,ly+(panelH-56)/2); } }catch(e){ drawADFallback(ctx,lx,ly+(panelH-56)/2); }
  ctx.fillStyle=THEME.fg; ctx.font='800 20px system-ui,-apple-system,Segoe UI,Roboto'; ctx.textBaseline='middle'; ctx.textAlign='left'; ctx.fillText(dealerName||$('dealer').value||'', textX, textY);
  ctx.restore();
  // Badge prix moderne
  const p = price(vehicle.price); if(p){ const bw=320, bh=120; const bx = photoRect.x + photoRect.w - bw - 18; const by = photoRect.y + photoRect.h - bh - 18; drawPriceBadge(ctx, bx, by, bw, bh, p); }
  // Statut
  if(status!=='aucun') statusStamp(ctx,status,photoRect,THEME.red);
  // Titre & sous-titres (plus bas)
  const titleY=photoRect.y+photoRect.h+96; ctx.fillStyle=THEME.fg; ctx.font='900 60px system-ui,-apple-system,Segoe UI,Roboto'; ctx.fillText(($('make').value+' '+$('model').value).toUpperCase(), M, titleY);
  const vY=titleY+40; ctx.font='700 32px system-ui,-apple-system,Segoe UI,Roboto'; ctx.fillText(($('version').value||'').toUpperCase(), M, vY);
  const fY=vY+38; ctx.font='800 28px system-ui,-apple-system,Segoe UI,Roboto'; ctx.fillText(($('features').value||'').toUpperCase(), M, fY);
  // Specs
  const sY=fY+54; ctx.fillStyle=THEME.sub; ctx.font='700 28px system-ui,-apple-system,Segoe UI,Roboto'; const specs=[$('year').value, $('gearbox').value, $('fuel').value, ($('power').value||'')+' ch', kms($('mileage').value)].filter(Boolean).join('  •  '); ctx.fillText(specs, M, sY);
  ctx.strokeStyle='#E5E7EB'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(M, sY+18); ctx.lineTo(outW-M, sY+18); ctx.stroke();
  // Téléphone (plus haut)
  const phoneY = outH - 260; const phoneTxt = $('phone').value||''; ctx.font='900 32px system-ui,-apple-system,Segoe UI,Roboto'; const tw=ctx.measureText(phoneTxt).width; const pw=tw+90, ph=56; const px=outW-M-pw, py=phoneY-ph/2; rr(ctx,px,py,pw,ph,28); ctx.fillStyle=THEME.blue; ctx.fill(); ctx.fillStyle='#fff'; ctx.fillText(phoneTxt, px+56, phoneY+12-12); ctx.beginPath(); ctx.arc(px+30, py+ph/2, 8, 0, Math.PI*2); ctx.fill();
  // Bandeau bas (auto-fit sur une ligne)
  const bandH = 72; const msg = 'Possibilité de reprise de votre véhicule   •   Recherche personnalisée : on trouve le modèle exact que vous cherchez'; ctx.fillStyle=THEME.blue; ctx.fillRect(0, outH-bandH, outW, bandH); ctx.fillStyle='#fff'; let size=28; const minS=18; const padX=36; do{ ctx.font=`800 ${size}px system-ui,-apple-system,Segoe UI,Roboto`; }while(ctx.measureText(msg).width>outW-2*padX && --size>=minS); const mw=ctx.measureText(msg).width; ctx.textBaseline='middle'; ctx.fillText(msg, (outW-mw)/2, outH-bandH/2+2);
}

function drawADFallback(ctx,x,y){ const s=56; ctx.save(); rr(ctx,x-6,y-4,s+12,s+8,10); ctx.fillStyle='#fff'; ctx.globalAlpha=0.95; ctx.fill(); ctx.globalAlpha=1; ctx.fillStyle=THEME.red; ctx.font='900 40px system-ui,-apple-system,Segoe UI,Roboto'; ctx.textBaseline='middle'; ctx.fillText('AD', x+10, y+s/2-2); ctx.restore(); }

/* ====== State + bindings ====== */
const state={ preset:'portrait', status:'aucun', focusX:0.82, focusY:0.60, focusOff:0.00 };
function schedule(){ if(window.__raf) cancelAnimationFrame(window.__raf); window.__raf=requestAnimationFrame(drawPreview); }
async function drawPreview(){ const c=$('preview'); const dims=PRESETS[state.preset]; $('previewLabel').textContent='Prévisualisation ('+dims.label+')'; const ratio=0.38; c.width=Math.round(dims.w*ratio); c.height=Math.round(dims.h*ratio); const off=document.createElement('canvas'); off.width=dims.w; off.height=dims.h; await renderSheet(off, { preset:state.preset, vehicle:{ make:$('make').value, model:$('model').value, version:$('version').value, features:$('features').value, year:$('year').value, gearbox:$('gearbox').value, fuel:$('fuel').value, mileage:$('mileage').value, power:$('power').value, price:$('price').value, phone:$('phone').value }, dealerName:$('dealer').value, logoUrl:logoURL, photoUrl:photoURL, focus:{scaleX:state.focusX,scaleY:state.focusY,offsetY:state.focusOff}, status:state.status }); const ctx=c.getContext('2d'); ctx.drawImage(off,0,0,c.width,c.height); }
function bind(){ ['make','model','version','features','year','gearbox','fuel','mileage','power','price','phone','dealer'].forEach(id=>$(id).addEventListener('input',schedule)); $('preset').addEventListener('change',()=>{ state.preset=$('preset').value; schedule(); }); $('status').addEventListener('change',()=>{ state.status=$('status').value; schedule(); }); ['focusX','focusY','focusOff'].forEach(id=>$(id).addEventListener('input',(e)=>{ const v=parseFloat(e.target.value); if(!Number.isNaN(v)) state[id]=v; schedule(); })); $('logoFile').addEventListener('change',e=>{ const f=e.target.files&&e.target.files[0]; if(!f||!f.type.startsWith('image/')) return; if(logoURL) URL.revokeObjectURL(logoURL); logoURL=URL.createObjectURL(f); schedule(); }); const pickPhoto=e=>{ const f=e.target.files&&e.target.files[0]; if(!f||!f.type.startsWith('image/')) return; if(photoURL) URL.revokeObjectURL(photoURL); photoURL=URL.createObjectURL(f); schedule(); }; $('photoFile').addEventListener('change', pickPhoto); $('photoCam').addEventListener('change', pickPhoto); $('btnGen').addEventListener('click', generatePNG); }

// iOS friendly download
function isIOS(){return /iPad|iPhone|iPod/.test(navigator.userAgent);} 
async function generatePNG(){ const dims=PRESETS[state.preset]; const c=$('export'); c.width=dims.w; c.height=dims.h; const preTab=isIOS()?window.open('about:blank','_blank'):null; await renderSheet(c, { preset:state.preset, vehicle:{ make:$('make').value, model:$('model').value, version:$('version').value, features:$('features').value, year:$('year').value, gearbox:$('gearbox').value, fuel:$('fuel').value, mileage:$('mileage').value, power:$('power').value, price:$('price').value, phone:$('phone').value }, dealerName:$('dealer').value, logoUrl:logoURL, photoUrl:photoURL, focus:{scaleX:state.focusX,scaleY:state.focusY,offsetY:state.focusOff}, status:state.status }); if(isIOS()){ const data=c.toDataURL('image/png'); if(preTab) preTab.location.href=data; else window.open(data,'_blank'); return; } c.toBlob((b)=>{ if(!b) return; const url=URL.createObjectURL(b); const a=document.createElement('a'); const fn=`${$('make').value}-${$('model').value}-${$('year').value}-${state.preset}`.replace(/[^a-z0-9-_]+/gi,'-'); a.href=url; a.download=fn+'.png'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),1200); },'image/png'); }

bind(); schedule();
</script>
</body>
</html>
